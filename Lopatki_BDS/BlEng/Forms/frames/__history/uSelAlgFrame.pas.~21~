unit uSelAlgFrame;

interface

uses
  Windows, Forms,  StdCtrls, uBtnListView, Controls, ComCtrls, Classes,
  ubldobj, utrend, uBldMath, usensor, uPair, uchart, ToolWin, ImgList, uBaseBldAlg,
  sysutils, udrawobj, uGistogram, uCommonTypes, ustage, utrendalg, uSensorRep,
  uBldObjList, uDensityForm, uSensorList, uCreateTrendForm, uGetSkipBladesAlg,
  uPairTrend;

type
  TSelectAlgFrame = class(TFrame)
    SelAlgFrame: TGroupBox;
    SelAlgLV: TBtnListView;
    SelectActionGB: TGroupBox;
    CancelBtn: TButton;
    ApplyBtn: TButton;
  private
    curObjList:cBldObjList;
    curchart:cchart;
  private
    procedure ShowAlgorithms;
  public
    procedure getObj(obj:cBldObjList);
    procedure getChart(chart:cchart);
    function apply:integer;
  end;

implementation
uses
  ubldeng, uRestoreVibrationAlg, uMultiSensor, uPairShape;

{$R *.dfm}

procedure TSelectAlgFrame.getChart(chart:cchart);
begin
  curchart:=chart;
end;

procedure TSelectAlgFrame.getObj(obj:cBldObjList);
begin
  curobjList:=obj;
  ShowAlgorithms;
end;

procedure TSelectAlgFrame.ShowAlgorithms;
var li:tlistitem;
begin
  SelAlgLV.Clear;
  if curobjList.Count=0 then exit;
  case curobjList.GetObjectsType of
    c_Sensor:
    begin
      if curobjList.Count>1 then
      begin
        // добавляем алгоритм "Статистика импульсов"
        li:=SelAlgLV.items.Add;
        SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
        SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sPairShape, li);
        SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
      end;
      // добавляем алгоритм "Статистика импульсов"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sStat, li);
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
      // добавляем алгоритм "Построить тахо"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sTaho, li);
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
      // добавляем алгоритм "восстановить сигнал"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sRestore, li );
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
      // добавляем алгоритм "восстановить сигнал"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sTrend, li );
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
      // добавляем алгоритм отчет по датчику
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sSensorRep, li );
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
      // добавляем алгоритм расчет пропуска лопаток
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sSkipSensorBlades, li );
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sSensor, li);
    end;
    c_Pair:
    begin
      // добавляем алгоритм "форма венца"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sShape, li);
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sPair, li);
      // добавляем алгоритм "форма венца"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sPairTrend, li);
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sPair, li);
    end;
    c_stage:
    begin
      // добавляем алгоритм "построение формы колеса"
      li:=SelAlgLV.items.Add;
      SelAlgLV.SetSubItemByColumnName('№', inttostr(li.Index), li);
      SelAlgLV.SetSubItemByColumnName('Алгоритм', c_sStageShape, li);
      SelAlgLV.SetSubItemByColumnName('Тип объекта', c_sStage, li);
    end;
  end;
  SelAlgLV.Selected:=SelAlgLV.Items[0];
end;

function TSelectAlgFrame.apply;
var
  i:integer;
  li:tlistitem;
  algname:string;
  trend:ctrend;
  eng:cbldeng;
  taho, sensor:csensor;
  stage:cstage;
  obj:cdrawobj;
  rect:frect;
  alg:cRestoreAlg;
  opts:cBaseOpts;
  f:tform;
begin
  eng:=curobjlist.GetObj(0).eng;
  li:=SelAlgLV.Selected;
  SelAlgLV.GetSubItemByColumnName('Алгоритм', li, algname);
  taho:=csensor(eng.GetTaho(curobjlist.GetObj(0), false));
  if algname=c_sTaho then
  begin
    trend:=SelGraphForm.ShowModal(curchart,csensor(curobjlist.GetObj(0)).name+'_Taho');
    if trend=nil then
      exit;
    trend.xunits:='date';
    trend.yunits:='rpm';
    trend.drawpoint:=false;
    // вычислить тахо
    EvalTaxo(csensor(curobjlist.GetObj(0)), trend);
    curchart.activepage.Normalise;
  end;
  if algname=c_sPairShape then
  begin
    trend:=SelGraphForm.ShowModal(curchart,csensor(curobjlist.GetObj(0)).name+'_PairShape');
    BuildMultiSensor(taho,cAlgSensorList(curobjlist),trend);
  end;
  if algname=c_sPairTrend then
  begin
    BuildPairTrends(taho,cAlgSensorList(curobjlist),curchart);
  end;
  if algname=c_sStat then
  begin
    DensityForm.ShowModal(taho,cAlgSensorList(curobjlist),curchart);
    for I := 0 to curchart.activepage.activeAxis.ChildCount - 1 do
    begin
      obj:=cdrawobj(curchart.activepage.activeAxis.getChild(i));
      if obj is ctrend then
        obj.visible:=false;
      if obj is cgistogram then
      begin
        rect.BottomLeft:=p2(0,0);
        rect.TopRight:=p2(360,obj.GetBound.TopRight.y*1.05);
        curchart.activepage.ZoomfRect(rect);
      end;
    end;
  end;
  if algname=c_sRestore then
  begin
    trend:=SelGraphForm.ShowModal(curchart,csensor(curobjlist.GetObj(0)).name+'_Restore');
    if trend<>nil then
      RestoreSignal(taho,cAlgSensorList(curobjlist),trend)
    else
      RestoreSignal(taho,cAlgSensorList(curobjlist),ctrend(curchart));
  end;
  if algname=c_sShape then
  begin
    BuildPairShape(taho,cAlgSensorList(curobjlist),curchart);
  end;
  if algname=c_sTrend then
  begin
    trend:=SelGraphForm.ShowModal(curchart,csensor(curobjlist.GetObj(0)).name+'_BladeTrend');
    generateTrend(taho,cAlgSensorList(curobjlist),curchart)
  end;
  if algname=c_sStageShape then
  begin
    sensor:=csensor(eng.GetObjDlg(curobjlist.GetObj(0),c_RootSensor));
    // произвести расчет расстояний между лопатками
    cstage(curobjlist.GetObj(0)).Shape.Eval(taho, sensor, curobjlist.GetObj(0),true, -1, -1);
  end;
  if algname=c_sSensorRep then
  begin
    // произвести расчет расстояний между лопатками
    GenerateReport(taho,cAlgSensorList(curobjlist),curchart);
  end;
  if algname=c_sSkipSensorBlades then
  begin
    // произвести расчет расстояний между лопатками
    GetSkipBlades(taho,cAlgSensorList(curobjlist), curchart);
  end;
end;

end.
