unit uXYTrendPos;

interface

uses
  Windows, SysUtils, Forms,  StdCtrls, DCL_MYOWN, Classes, uMeraSignal,
  uTickData,uBldMath, uBldFile, usensor, Controls,  utrend, ustage, uTrendSignal,
  Spin, CommonOptsFrame, uBaseBldAlg, usensorlist, uTag, uAxis, uSaveSignalForm,
  uTagSignal;

type
  TXYTrendForm = class(TForm)
    VibrPeriodLabel: TLabel;
    PeriodFE: TFloatEdit;
    CancelBtn: TButton;
    OkBtn: TButton;
    StartBladeSE: TSpinEdit;
    BladeIndLabel: TLabel;
    BaseAlgOptsFrame1: TBaseAlgOptsFrame;
    EndBladeSE: TSpinEdit;
    Label1: TLabel;
    MeraFileCB: TCheckBox;
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
  private
    procedure setopts(opts:cBaseOpts);
    procedure getopts(o:cBaseOpts);
  public
    function ShowModal(t:csensor;sensors:calgsensorlist; opts:cBaseOpts):integer;
  end;

var
  XYTrendForm: TXYTrendForm;

implementation
uses
  uTrendAlg;
{$R *.dfm}

procedure TXYTrendForm.setopts(opts:cBaseOpts);
begin
  PeriodFE.FloatNum:=ctrendalgopts(opts).T;
  if opts.stage<>nil then
  begin
    EndBladeSE.Value:=opts.stage.BladeCount-1;
    EndBladeSE.MaxValue:=opts.stage.BladeCount-1;
    EndBladeSE.MinValue:=0;

    StartBladeSE.Value:=0;
    StartBladeSE.MaxValue:=opts.stage.BladeCount-1;
    StartBladeSE.MinValue:=0;
  end;
end;

procedure TXYTrendForm.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key=13 then
    modalresult:=mrok;
  if key=27 then
    modalresult:=mrcancel;
end;

procedure TXYTrendForm.getopts(o:cBaseOpts);
begin
  BaseAlgOptsFrame1.GetOpts(o);
  ctrendalgopts(o).t:=PeriodFE.FloatNum;
end;

function TXYTrendForm.ShowModal(t:csensor;sensors:calgsensorlist; opts:cBaseOpts):integer;
var
  alg:ctrendalg;
  s:csensor;
  tag:cBaseTag;
  i:integer;
  list:tStringList;
  ax:caxis;
  tr:ctrend;
  signal:cTagSignal;
  // перевод из градусов в мм
  k1:single;
begin
  BaseAlgOptsFrame1.SetOpts(t,sensors,Opts);
  setopts(opts);
  if inherited showmodal = mrok then
  begin
    GetOpts(opts);
    // выполняем алгоритм
    alg:=ctrendalg.create;
    alg.sensorsList:=sensors;
    alg.getOpts(opts);
    k1:=cstage(sensors.stage).getscale;
    // лист содержит тренды для записи в мера файл
    if merafilecb.Checked then
      list:=TStringList.Create;
    ax:=caxis(opts.trend.GetParentByClassName('cAxis'));
    for i:=StartBladeSE.Value to EndBladeSE.Value do
    begin
      tag:=cbasetag(alg.tags.getobj('XYArray_'+inttostr(i)));
      tag.active:=true;
      // сохранение в мера файл
      if merafilecb.Checked then
      begin
        signal:=cTagSignal.Create;
        signal.obj:=tag;
        signal.k1:=k1;
        signal.k0:=0;
        signal.yUnits:='мм';
        signal.xUnits:='сек';
        // чистка происходит внутри mera файла
        list.AddObject(tag.name, signal);
      end
      else
      begin
        if i=StartBladeSE.Value then
        begin
          tag.DrawObj:=opts.trend;
          tag.DrawObj.name:=tag.name;
        end
        else
        begin
          tr:=ax.AddTrend;
          tag.DrawObj:=tr;
          tag.DrawObj.name:=tag.name;
        end;
      end;
    end;
    alg.apply(t,sensors,opts);
    // сохранение в мера файл
    if merafilecb.Checked then
    begin
      SaveSignalsForm.ShowModal(list);
    end;
    list.Destroy;
    // очистка данных
    alg.Destroy;
  end;
end;

end.
