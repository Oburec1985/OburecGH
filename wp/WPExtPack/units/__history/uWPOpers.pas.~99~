unit uWPOpers;

interface

uses
  Windows, ActiveX, Classes, ComObj, uNiiPMlib_TLB, StdVcl,
  uBaseObjService, variants, sysutils,
  Winpos_ole_TLB, uCommonMath,  uCommonTypes, uWPProcServices, mathfunction,
  uWPEvents, posbase, u2dMath, uWPServices,
  math;

Function GetMO(s: iwpsignal): double;
// СКО
Function GetRMS(s: iwpsignal): double;
function GetIntervalSignal (t1t2:point2d; s:iwpsignal):iwpsignal;
function AddConstant (c:double; s:iwpsignal):iwpsignal;
// привести к интервалу 0..1 dt
function Normalise0_1(const sig: olevariant; MinMax:point2d): iwpsignal;
// Умножение на константу
function Multiply(const sig: olevariant; const d:double): iwpsignal;
// Передискретизация
function Resample(const sig: olevariant; const freq:double): iwpsignal;
// Усреднение
function TrendMO(const sig: olevariant; const points:integer): iwpsignal;
function LPF(const sig: olevariant; const order:integer; freq:double): iwpsignal;
// Фиьлтр Oburec
function H2Flt(const sig: olevariant; const points:integer; resample:integer): iwpsignal;
// параметр по параметру (возвращает сигнал xy)
// sx, sy - iwpsignal
function BuildWPDependence(sx, sy: olevariant): iwpSignal;
// построить закон распределения вероятности. На вход надо подать плотность распределения вероятности
function BuildProbabilityDistribution(s: iwpsignal; palfa:double):iwpSignal;

//function TypeCastToIWPUSML(d: idispatch): iwpusml;
//function TypeCastToIWNode(d: idispatch): iwpnode;
//function TypeCastToIWSignal(d: idispatch): iwpsignal; overload;
//function TypeCastToIWSignal(n: iwpnode): iwpsignal; overload;

function getISignalByPath(str:string):iwpsignal;

implementation

uses
  uWPExtPack, uWPExtOperHilbFilter;

function getISignalByPath(str:string):iwpsignal;
var
  d:idispatch;
begin
  d:=wp.GetNodeStr(str);
  result:=TypeCastToIWSignal(d);
end;

Function GetRMS(s: iwpsignal): double;
var
  oper:iwpoperator;
  opts:string;
  r1,r2:olevariant;
begin
  oper:=WP.GetObject('/Operators/Вероятн. характеристики') as IWPOperator;
  // 0- прибавить константу
  oper.Exec(s,s,refvar(r1),refvar(r2));
  //result.M := r1.GetY(0);
  //result.D := r1.GetY(1);
  //result.E := r1.GetY(2);
  //result.A3 := r1.GetY(3);
  //result.A4 := r1.GetY(4);
  //result.R := r1.GetY(5) * 2;
  //result.RMS := r1.GetY(6);
  result:=r1.GetY(2);
end;

function GetMO(s: iwpsignal): double;
var
  oper:iwpoperator;
  opts:string;
  r1,r2:olevariant;
begin
  oper:=WP.GetObject('/Operators/Вероятн. характеристики') as IWPOperator;
  // 0- прибавить константу
  oper.Exec(s,s,refvar(r1),refvar(r2));
  //result.M := r1.GetY(0);
  //result.D := r1.GetY(1);
  //result.E := r1.GetY(2);
  //result.A3 := r1.GetY(3);
  //result.A4 := r1.GetY(4);
  //result.R := r1.GetY(5) * 2;
  //result.RMS := r1.GetY(6);
  result:=r1.GetY(0);
//var
//  i: integer;
//  y: double;
//begin
//  y := 0;
//  if s.size <> 0 then
//  begin
//    for i := 0 to s.size - 1 do
//    begin
//      y := s.GetY(i) + y;
//    end;
//    result := y / s.size;
//  end;
end;

function GetIntervalSignal (t1t2:point2d; s:iwpsignal):iwpsignal;
begin
  result:=wp.GetInterval(s,s.IndexOf(t1t2.x), s.IndexOf(t1t2.y)-s.IndexOf(t1t2.x)) as iwpsignal;
end;

function BuildProbabilityDistribution(s: iwpsignal;palfa:double):iwpSignal;
var
  I: Integer;
  v,d, sigma, x:double;
  p1,p2:point2d;
  sum:double;
  b:boolean;
begin
  // нормальный закон, вероятность 2 сигма
  sigma:=palfa;
  b:=true;
  result:=s.Clone(0, s.size) as iwpsignal;
  d:=s.DeltaX;
  sum:=0;
  for I := 0 to s.size - 1 do
  begin
    v:=s.getY(i);
    sum:=v+sum;
    result.setY(i, sum*d);
    result.StartX:=-d;
    // необходимо считать 2sigma
    if b then
    begin
      if (sum*d)>sigma then
      begin
        p1.x:=result.GetX(i-1);
        p1.y:=result.Gety(i-1);
        p2.x:=result.GetX(i);
        p2.y:=result.Gety(i);
        x:=EvalLineX(sigma, p1,p2);
        result.SetProperty('Sigma', floattostr(x));
        b:=false;
      end;
    end;
  end;
end;

function BuildWPDependence(sx, sy: olevariant): iwpSignal;
var
  oper: iwpoperator;
  pars: tstringlist;
  opts, str, flP: string;
  r1, r2: olevariant;
  s1, s2: iwpSignal;
begin
  oper := WP.GetObject('/Operators/Параметрический график') as iwpoperator;
  opts :=
    'type=0,p2xy=0,crop=0,left=0,right=0,top=0,bottom=0,angle0=0,clcw=0,degr=0';
  oper.loadProperties(opts);
  oper.Exec(sy, sx, refvar(r1), refvar(r2));
  result := iwpSignal(TVarData(r1).VPointer);
end;

function AddConstant (c:double; s:iwpsignal):iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str, flP:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/Operators/Арифм. операции') as IWPOperator;
  flP:=replaceChar(floattostr(c),',','.');
  // 0- прибавить константу
  opts:='kind=0,const='+flP;
  oper.loadProperties(opts);
  oper.Exec(s,s,refvar(r1),refvar(r2));
  result:=iwpsignal(TVarData(r1).VPointer);
end;

function Resample(const sig: olevariant; const freq:double):iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str, flP:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/Operators/Передискретизация') as IWPOperator;
  flP:=replaceChar(floattostr(freq),',','.');

  // 2- умножение на константу
  opts:='kind=1,type=0,freq='+flP;
  oper.loadProperties(opts);
  oper.Exec(sig,sig,refvar(r1),refvar(r2));
  result:=iwpsignal(TVarData(r1).VPointer);
end;

function H2Flt(const sig: olevariant; const points:integer; resample:integer): iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str, flP:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/Расширения/'+HilbFltRegName) as IWPOperator;
  opts:=TExtOperHilbertFlt(oper).m_opts;
  ChangeParamF(opts,c_NPoints,inttostr(points));
  //ChangeParamF(opts,c_Resample,resample);
  //oper.SetPropStr
  // 2- умножение на константу
  opts:='typeRes=3,bEquivMag=0,nPoints='+flP;
  oper.loadProperties(opts);
  oper.Exec(sig,sig,refvar(r1),refvar(r2));
  result:=iwpsignal(TVarData(r1).VPointer);
end;

function LPF(const sig: olevariant; const order:integer; freq:double): iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/Operators/Нерекурсивная фильтрация') as IWPOperator;
  opts:='flag=0,nOrder=51,iType=1,iKind=1,iTypeWin=3,fsr=30,fn=1,fv=30,fs=602.353';
  str:='nOrder='+inttostr(order)+',';
  //s1:=sig.vt;
  str:=str+'fs='+replaceChar(floattostr(1/sig.DeltaX),',','.')+',';
  str:=str+'fsr='+replaceChar(floattostr(freq),',','.');
  opts:=updateParams(opts, str);
  oper.loadProperties(opts);
  oper.Exec(sig,sig,refvar(r1),refvar(r2));
  result:=iwpsignal(TVarData(r1).VPointer);
end;

function TrendMO(const sig: olevariant; const points:integer): iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str, flP:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/VibroOpers/Последовательная обработка (тренды)') as IWPOperator;
  flP:=inttostr(points);
  // 3- среднее 0 -RMS
  opts:='typeRez=3,bEquivMag=0,nPoints='+flP;
  oper.loadProperties(opts);
  oper.Exec(sig,sig,refvar(r1),refvar(r2));
  result:=iwpsignal(TVarData(r1).VPointer);
end;

function Multiply(const sig: olevariant; const d:double): iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str, flP:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/Operators/Арифм. операции') as IWPOperator;
  flP:=replaceChar(floattostr(d),',','.');
  // 2- умножение на константу
  opts:='kind=2,const='+flP;
  oper.loadProperties(opts);
  oper.Exec(sig,sig,refvar(r1),refvar(r2));
  result:=iwpsignal(TVarData(r1).VPointer);
end;

function Normalise0_1(const sig: olevariant; MinMax:point2d): iwpsignal;
var
  oper:iwpoperator;
  pars:tstringlist;
  opts, str, flP:string;
  r1,r2:olevariant;
  s1, s2:iwpsignal;
begin
  oper:=WP.GetObject('/Operators/Арифм. операции') as IWPOperator;
  // вычитание
  flP:=replaceChar(floattostr(minMax.x),',','.');
  opts:='kind=1,const='+flP;
  oper.loadProperties(opts);
  oper.Exec(sig,sig,refvar(r1),refvar(r2));
  // деление
  s1 := iwpsignal(TVarData(r1).VPointer);
  flP:=replaceChar(floattostr(minMax.y-minMax.x),',','.');
  opts:='kind=3,const='+flp;
  oper.loadProperties(opts);
  oper.Exec(s1,s1,refvar(r1),refvar(r2));

  s2 := iwpsignal(TVarData(r1).VPointer);
  wp.Link('/Signals/results', s2.sname, s2 as IDispatch);
  result:=s2;
end;

end.
