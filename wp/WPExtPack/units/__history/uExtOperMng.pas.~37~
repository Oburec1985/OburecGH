unit uExtOperMng;

interface
uses
  ComObj, ActiveX, WPExtPack_TLB, Winpos_ole_TLB,
  StdVcl, PosBase, uMNK, variants,
  uWPProc, uCommonTypes, uWPservices,
  ComServ, uCommonMath, sysutils, classes,
  uwpOpers,
  uWPExtOperHilbFilter,
  uFindMaxOper,
  uWPExtOperRpt,
  uFrmHibFltFrm,
  Windows
  ;

type
  TExtOperMng = class
  public
    eoAmpFind: TExtOperAmpFind;
    eoRpt: TExtOperRpt;
    eoHilbFlt: TExtOperHilbertFlt;
    m_mng:cWPObjMng;
  public
    procedure NotifyPlugin(what:integer);
    constructor create(p_mng:cWPObjMng);
    destructor destroy;
  end;

var
  // указатель на тулбар винпоса
  bar_ID: Integer;
  // id ком excel
  ID_ExcelReport: Integer = 2;
  ID_ExcelReportBand: Integer = 3;

implementation

destructor TExtOperMng.destroy;
begin
  eoAmpFind.destroy;
  eoRpt.destroy;
  eoHilbFlt.destroy;
end;


constructor TExtOperMng.create(p_mng:cWPObjMng);
var
  hbmp:cardinal;
  b:boolean;
begin
  m_mng:=p_mng;
  bar_ID := WINPOS.CreateToolbar();

  eoHilbFlt:= TExtOperHilbertFlt.create();
  eoHilbFlt.linc(m_mng);
  b:=WINPOS.RegisterExtOper(eoHilbFlt, 1, 1, HilbFltRegName, 'Hilb', true);
  HilbFltFrm:=THilbFltFrm.Create(nil);
  HilbFltFrm.linc(m_mng, eoHilbFlt);


  eoAmpFind := TExtOperAmpFind.create();
  eoAmpFind.linc(m_mng);
  // последний параметр определеяет будет ли вызван диалог настройки оператора
  // по умолчанию(диапазон обработки)
  b:=WINPOS.RegisterExtOper(eoAmpFind, 1, 1, FindMaxRegName, 'AmpFind', true);

  eoRpt := TExtOperRpt.create();
  eoRpt.linc(m_mng);
  ID_ExcelReport := WINPOS.RegisterCommand();
  // последний параметр определеяет будет ли вызван диалог настройки оператора
  // по умолчанию(диапазон обработки)
  b:=WINPOS.RegisterExtOper(eoRpt, 1, 1, RptRegName, 'Rpt', true);
  hbmp := LoadBitmap(HInstance, 'ExcRep');
  WINPOS.CreatetoolbarButton(bar_ID, ID_ExcelReport, hbmp,
    'Отчет Excel'#10'Отчет Excel');
end;

procedure TExtOperMng.NotifyPlugin(what:integer);
begin
  // запуск плагина
  if HIWORD(what) = ID_ExcelReport then
  begin
    eoRpt.Setup;
  end;
end;

end.
