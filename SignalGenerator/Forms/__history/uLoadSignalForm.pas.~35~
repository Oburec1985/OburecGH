unit uLoadSignalForm;

interface

uses
  Windows, SysUtils, Classes, Graphics, Forms, umerasignal, inifiles,
  Dialogs, StdCtrls, DCL_MYOWN, Controls, umerafile, ubuffsignal1d;

type
  TLoadSignalForm = class(TForm)
    PathBtn: TButton;
    OpenDialog1: TOpenDialog;
    PathEdit: TEdit;
    CancelBtn: TButton;
    ApplyBtn: TButton;
    procedure PathBtnClick(Sender: TObject);
  public
    signals:cMeraFile;
  private
  public
    function LoadMera(path:string):boolean;
    function LoadSignals(p_signals:cMeraFile):boolean;
  end;

var
  LoadSignalForm: TLoadSignalForm;

implementation

{$R *.dfm}

function TLoadSignalForm.LoadSignals(p_signals:cMeraFile):boolean;
begin
  result:=false;
  signals:=p_signals;
  if showmodal=mrok then
  begin
    result:=LoadMera(PathEdit.Text);
  end;
end;

procedure TLoadSignalForm.PathBtnClick(Sender: TObject);
begin
  if OpenDialog1.execute then
  begin
    pathedit.Text:=opendialog1.FileName;
  end;
end;

function TLoadSignalForm.LoadMera(path:string):boolean;
var
  ifile:tinifile;
  sections:tstringlist;
  folder,fname:string;
  I,len: Integer;
  s:cbuffsignal1d;
  f:file;
begin
  result:=false;
  ifile:=TIniFile.Create(path);
  sections:=tstringlist.Create;
  ifile.ReadSections(sections);
  folder:=extractfiledir(path);
  signals.clear;
  for I := 0 to sections.Count - 1 do
  begin
    if lowercase(sections.Strings[i])<>'mera' then
    begin
      fname:=folder+'\'+sections.Strings[i]+'.dat';
      if fileexists(fname) then
      begin
        s:=cbuffsignal1d.create;
        s.name:=sections.Strings[i];
        s.ffreqX:=ifile.ReadInteger(sections.Strings[i],'freq',1);
        AssignFile(f,fname);
        reset(f,1);
        len:=trunc(FileSize(f)/4);
        s.capacity:=len;
        blockread(f,cbuffsignal1d(s).points[0],FileSize(f),len);
        signals.add(s);
        //signal.EvalEstimates;
        result:=true;
      end;
    end;
  end;
end;

end.
